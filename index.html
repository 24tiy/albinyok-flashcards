<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>CSV Flashcards (Q/A)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="–§–ª–µ—à‚Äë–∫–∞—Ä—Ç—ã –∏–∑ CSV –¥–ª—è —Å–∞–º–æ–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ GitHub –∏–ª–∏ —Ñ–∞–π–ª–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω –∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö.">
  <!-- PapaParse –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --bg:hsl(220 20% 98%); --bg-alt:hsl(220 30% 96%); --card:#fff; --text:hsl(222 47% 18%); --muted:hsl(222 22% 40%); --accent:hsl(258 90% 66%); --accent-2:hsl(200 90% 60%); --ok:hsl(150 70% 40%); --bad:hsl(0 80% 55%); --shadow:0 10px 30px rgba(20,20,40,.08); }
    @media (prefers-color-scheme: dark){ :root { --bg:hsl(222 20% 9%); --bg-alt:hsl(222 18% 13%); --card:hsl(222 15% 12%); --text:hsl(0 0% 98%); --muted:hsl(220 10% 70%); --shadow:0 10px 30px rgba(0,0,0,.35) } }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,Arial; background:radial-gradient(1200px 600px at 10% -20%, var(--bg-alt), transparent 60%), radial-gradient(1200px 600px at 110% 10%, var(--bg-alt), transparent 60%), var(--bg); color:var(--text); line-height:1.45}
    .container{max-width:980px;margin:0 auto;padding:28px 10px 64px}
    @media (max-width:480px){
      .container{padding:12px 1vw 24px;}
      .card{padding:15px;}
      .controls{flex-direction:column; gap:7px;}
    }
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow);display:grid;place-items:center;color:white;font-weight:800}
    h1{font-size:clamp(22px,4vw,30px);margin:0}
    .sub{color:var(--muted);font-size:14px}
    .lang{margin-left:auto; font-size:13px;}
    .uploader{margin:22px 0;padding:18px 10px 18px 18px;border:2px dashed rgba(0,0,0,.10);border-radius:20px;background:rgba(0,0,0,.03)}
    @media (prefers-color-scheme: dark){.uploader{border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.03)}}
    .uploader.drag{border-color:var(--accent);background:rgba(139,92,246,.08)}
    .uploader .row{display:flex;flex-wrap:wrap;align-items:center;gap:12px}
    .btn{appearance:none;border:none;background:var(--accent);color:#fff;border-radius:12px;padding:9px 14px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:filter .16s}
    .btn.secondary{background:var(--accent-2)}
    .btn.ghost{background:transparent;color:var(--accent);border:1.5px solid var(--accent)}
    .btn:active,.btn.active{filter: brightness(0.83);}
    input[type=file]{display:none}
    label.file{display:inline-flex;gap:10px;align-items:center;background:var(--card);border:1.5px solid rgba(0,0,0,.08);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
    .urlbox{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .urlbox input[type=url]{flex:1;min-width:120px;border-radius:12px;border:1.5px solid rgba(0,0,0,.12);padding:8px 10px;background:var(--card);}
    .picker{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    select{border-radius:12px;border:1.5px solid rgba(0,0,0,.12);padding:9px 10px;background:var(--card);}
    .workspace{display:none;margin-top:24px}
    .chip{background:var(--card);border:1px solid rgba(0,0,0,.08);padding:6px 10px;border-radius:999px;box-shadow:var(--shadow);font-size:13px}
    .progress{height:8px;background:rgba(0,0,0,.07);border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
    .card{position:relative;background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:26px;min-height:120px;display:flex;align-items:center;justify-content:center;text-align:center}
    .q{font-size:clamp(18px,2.4vw,22px);font-weight:700}
    .a{font-size:clamp(16px,2.1vw,20px);margin-top:10px;display:none;color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-top:16px}
    .ctrl{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1.5px solid rgba(0,0,0,.08);background:var(--card);cursor:pointer;box-shadow:var(--shadow);font-weight:700;transition:filter .15s;}
    .ctrl.ok{color:var(--ok)} .ctrl.bad{color:var(--bad)}
    .ctrl.active{filter: brightness(0.7);}
    .topbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .tiny{font-size:12px;color:var(--muted)} .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:rgba(0,0,0,.08);padding:2px 6px;border-radius:6px}
    .hidden{display:none !important} .error{padding:12px 14px;border-radius:12px;background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.25)}
    .exportbar{display:flex;gap:8px;margin-top:10px;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Q‚ÜîA</div>
      <div>
        <h1>CSV Flashcards</h1>
        <div class="sub">–§–ª–µ—à‚Äë–∫–∞—Ä—Ç—ã –∏–∑ CSV ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å—Å—ã–ª–∫—É —Å GitHub. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ. <a href="README.md" style="color:var(--accent)">–ü–æ–º–æ—â—å</a></div>
      </div>
      <div class="lang">
        <label><input type="radio" name="lang" value="ru" checked>RU</label>
        <label><input type="radio" name="lang" value="en">EN</label>
      </div>
    </header>
    <section class="uploader" id="uploader" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞ CSV">
      <h2>1) –§–∞–π–ª –∏–ª–∏ —Å—Å—ã–ª–∫–∞</h2>
      <div class="row" style="margin-bottom:12px">
        <label for="file" class="file" id="fileLabel">üìÑ –§–∞–π–ª CSV</label>
        <input type="file" id="file" accept=".csv,text/csv" />
        <button class="btn secondary" id="templateBtn" type="button">–®–∞–±–ª–æ–Ω CSV</button>
        <button class="btn ghost" id="demoBtn" type="button">–î–µ–º–æ‚Äë–Ω–∞–±–æ—Ä</button>
      </div>
      <div class="urlbox">
        <input type="url" id="urlInput" placeholder="https://raw.githubusercontent.com/24tiy/flashcards-naturalisation/main/Questions_et_r_ponses.csv" />
        <button class="btn" id="loadUrlBtn" type="button">–ü–æ —Å—Å—ã–ª–∫–µ</button>
      </div>
      <div class="picker">
        <select id="csvPicker"><option value="">‚Ä¶–∏—â–µ–º CSV –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏‚Ä¶</option></select>
        <button class="btn" id="loadPickedBtn" type="button" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ GitHub</button>
      </div>
      <div class="tiny">URL‚Äë–ø–∞—Ä–∞–º–µ—Ç—Ä—ã: <code>?owner=‚Ä¶&repo=‚Ä¶&branch=‚Ä¶&csv=path/in/repo.csv</code>. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é owner=<b>24tiy</b>, repo=<b>flashcards-naturalisation</b>, branch=<b>main</b>.</div>
      <div id="error" class="error hidden" role="alert"></div>
    </section>
    <section class="workspace" id="workspace" aria-live="polite">
      <div class="topbar">
        <div>
          <span class="chip" id="deckName">–î–µ–∫: ‚Äî</span>
          <span class="chip" id="counter">0 / 0</span>
          <span class="chip" id="score">‚úì 0 ‚Ä¢ ‚úó 0</span>
        </div>
        <div>
          <button class="btn ghost" id="shuffleBtn" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å (S)">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
          <button class="btn ghost" id="resetBtn" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <label class="file" for="reupload">‚Üª –§–∞–π–ª CSV</label>
          <input type="file" id="reupload" accept=".csv,text/csv" />
        </div>
      </div>
      <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
      <div class="card" id="card"><div class="q" id="q">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è</div><div class="a" id="a"></div></div>
      <div class="controls" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button class="ctrl" id="prevBtn" title="–ù–∞–∑–∞–¥ (‚Üê)">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="ctrl" id="revealBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç (–ü—Ä–æ–±–µ–ª/Enter)">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
        <button class="ctrl" id="nextBtn" title="–í–ø–µ—Ä—ë–¥ (‚Üí)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
        <button class="ctrl ok" id="markOkBtn" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∑–Ω–∞—é (K)">‚úì –ó–Ω–∞—é</button>
        <button class="ctrl bad" id="markBadBtn" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –Ω–µ –∑–Ω–∞—é (J)">‚úó –ù–µ –∑–Ω–∞—é</button>
      </div>
      <div class="tiny" style="text-align:center;margin-top:8px">Space/Enter ‚Äî –æ—Ç–≤–µ—Ç ¬∑ ‚Üê/‚Üí ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è ¬∑ J/K ‚Äî –Ω–µ –∑–Ω–∞—é/–∑–Ω–∞—é ¬∑ S ‚Äî –ø–µ—Ä–µ–º–µ—à–∞—Ç—å</div>
      <div class="exportbar">
        <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        <button class="btn ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
    </section>
  </div>
  <script>
  // ====== –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è language switcher ======
  const translations = {
    ru:{
      q: "–í–æ–ø—Ä–æ—Å",
      a: "–û—Ç–≤–µ—Ç",
      file: "–§–∞–π–ª CSV",
      template: "–®–∞–±–ª–æ–Ω CSV",
      demo: "–î–µ–º–æ‚Äë–Ω–∞–±–æ—Ä",
      url: "–ü–æ —Å—Å—ã–ª–∫–µ",
      repo: "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ GitHub",
      error: "–û—à–∏–±–∫–∞",
      empty: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π",
      reveal: "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç",
      hide: "–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç",
      prev: "‚Üê –ù–∞–∑–∞–¥",
      next: "–í–ø–µ—Ä—ë–¥ ‚Üí",
      know: "‚úì –ó–Ω–∞—é",
      dont: "‚úó –ù–µ –∑–Ω–∞—é",
      shuffle: "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å",
      reset: "–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å",
      deck: "–î–µ–∫",
      progress: "–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞",
      clear: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë"
    },
    en:{
      q: "Question",
      a: "Answer",
      file: "CSV File",
      template: "Download Template",
      demo: "Demo Set",
      url: "Load URL",
      repo: "Load from GitHub",
      error: "Error",
      empty: "Upload a CSV or select a repo file",
      reveal: "Show answer",
      hide: "Hide answer",
      prev: "‚Üê Back",
      next: "Next ‚Üí",
      know: "‚úì I know",
      dont: "‚úó I don't know",
      shuffle: "Shuffle",
      reset: "Reset",
      deck: "Deck",
      progress: "Export progress",
      clear: "Clear all"
    }
  };
  let curLang = "ru";
  function t(k){ return translations[curLang][k]||k; }
  document.querySelectorAll('input[name=lang]').forEach(r=>r.addEventListener('change', e=>{ curLang=e.target.value; updateLang(); }));
  function updateLang(){
    // –ø—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ UI, –º–æ–∂–µ—à—å –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –Ω–∞–¥–ø–∏—Å–µ–π
    document.querySelector("label[for='file']").textContent = "üìÑ "+t('file');
    document.getElementById("templateBtn").textContent = t('template');
    document.getElementById("demoBtn").textContent = t('demo');
    document.getElementById("loadUrlBtn").textContent = t('url');
    document.getElementById("loadPickedBtn").textContent = t('repo');
    document.getElementById("prevBtn").textContent = t('prev');
    document.getElementById("revealBtn").textContent = t('reveal');
    document.getElementById("nextBtn").textContent = t('next');
    document.getElementById("markOkBtn").textContent = t('know');
    document.getElementById("markBadBtn").textContent = t('dont');
    document.getElementById("shuffleBtn").textContent = t('shuffle');
    document.getElementById("resetBtn").textContent = t('reset');
    document.getElementById("exportBtn").textContent = t('progress');
    document.getElementById("clearBtn").textContent = t('clear');
  }

  // ===== –í—Å—è –ª–æ–≥–∏–∫–∞ –Ω–∏–∂–µ =====
  function $(s){ return document.querySelector(s); }
  function sniffHeader(a){
    if(!a || a.length<2) return false;
    var ha=(a[0]||'').toLowerCase(), hb=(a[1]||'').toLowerCase();
    return ['q','question','–≤–æ–ø—Ä–æ—Å'].includes(ha) && ['a','answer','–æ—Ç–≤–µ—Ç'].includes(hb);
  }
  function toDeck(rows){
    if(!rows||!rows.length) return [];
    let filtered=[];
    for(let i=0;i<rows.length;i++){
      let r=rows[i], q=(r[0]||'').trim(), a=(r[1]||'').trim();
      if(q+a==='') continue;
      filtered.push([q,a]);
    }
    if(!filtered.length) return [];
    let skip=sniffHeader(filtered[0]) ? 1:0, out=[];
    for(let i=skip;i<filtered.length;i++){
      out.push({q:filtered[i][0], a:filtered[i][1], ok:false, bad:false});
    }
    return out;
  }
  
  var deck=[], idx=0, shown=false, deckName='‚Äî';
  function updateUI(){
    var q=$('#q'), a=$('#a'), c=$('#counter'), s=$('#score'), n=$('#deckName'), bar=$('#progressBar');
    if(!deck.length){
      q.textContent = t('empty');
      a.textContent = '';
      a.style.display = 'none';
      if(c) c.textContent = '0 / 0';
      if(s) s.textContent = '‚úì 0 ‚Ä¢ ‚úó 0';
      if(n) n.textContent = t('deck') + ': ‚Äî';
      if(bar) bar.style.width = '0%';
      return;
    }
    var card=deck[idx];
    q.textContent = card.q || '('+ t('q').toLowerCase() +'?)';
    a.textContent = card.a || '('+ t('a').toLowerCase() +'?)';
    a.style.display=shown?'block':'none';
    if(c) c.textContent=(idx+1)+' / '+deck.length;
    var ok=deck.filter(x=>x.ok).length, bad=deck.filter(x=>x.bad).length;
    if(s) s.textContent='‚úì '+ok+' ‚Ä¢ ‚úó '+bad;
    if(n) n.textContent=t('deck')+': '+deckName;
    if(bar) bar.style.width=Math.round(((ok+bad)/Math.max(deck.length,1))*100)+'%';
    var rb=$('#revealBtn'); if(rb) rb.textContent=shown?t('hide'):t('reveal');
  }
  function showWorkspace(){ $('#uploader').classList.add('hidden'); $('#workspace').style.display='block'; }
  function showUploader(){ $('#uploader').classList.remove('hidden'); $('#workspace').style.display='none'; }
  function persist(){
    localStorage.setItem('csv-flashcards-v6',JSON.stringify({deck,idx,shown,deckName,lang:curLang}))
  }
  function restore(){
    try{
      let raw=localStorage.getItem('csv-flashcards-v6');
      if(!raw) return false;
      let p=JSON.parse(raw);
      if(p && p.deck && p.deck.length){
        deck=p.deck; idx=Math.min(Math.max(0,p.idx|0),deck.length-1); shown=!!p.shown; deckName=p.deckName||'‚Äî';
        if(p.lang) { curLang=p.lang; $("input[name=lang][value='"+curLang+"']").checked=true; updateLang(); }
        showWorkspace(); updateUI(); return true;
      }
    }catch(e){}
    return false;
  }
  function loadCSVText(text,name){
    try{
      // ---- –ù–∞–¥—ë–∂–Ω—ã–π CSV-–ø–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ PapaParse ---
      let parsed = Papa.parse(text.trim(), {skipEmptyLines:true});
      if(parsed.errors && parsed.errors.length) throw new Error(parsed.errors[0].message);
      let d=toDeck(parsed.data);
      if(!d.length) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–∞—Ä '–≤–æ–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç'");
      deck = d; idx=0; shown=false; deckName=name||'';
      persist(); showWorkspace(); updateUI();
    }catch(e){
      let err=$('#error');
      if(err){ err.textContent=(t('error')+': ')+(e.message||e); err.classList.remove('hidden'); }
      showUploader();
    }
  }
  function loadFromURL(url){
    return fetch(url,{cache:'no-store'}).then(res=>{
      if(!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ('+res.status+')');
      if(+res.headers.get('content-length')>500000) throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!');
      return res.text();
    }).then(txt=>{
      let name=decodeURIComponent(url.split('/').pop()||'–£–¥–∞–ª—ë–Ω–Ω—ã–π CSV');
      loadCSVText(txt,name);
    });
  }
  function getParams(){
    var p={},qs=location.search.replace(/^\?/,'').split('&');
    for(var i=0;i<qs.length;i++){
      var kv=qs[i].split('='); if(kv[0]) p[decodeURIComponent(kv[0])]=decodeURIComponent(kv[1]||'');
    }
    return p;
  }
  function rawURL(owner,repo,branch,path){
    return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
  }
  // ---- GitHub Trees API ----
  function defaults(){ return { owner:'24tiy',repo:'flashcards-naturalisation',branch:'main' }; }
  function listCsvViaTrees(owner,repo,branch){
    var url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
    return fetch(url,{headers:{'Accept':'application/vnd.github+json'}})
        .then(res=>{ if(!res.ok) throw new Error('GitHub API: '+res.status); return res.json(); })
        .then(data=>{
          var tree=(data&&data.tree)?data.tree:[], files=[];
          for(let it of tree){ if(it.type==='blob' && /\.csv$/i.test(it.path)) files.push({path:it.path, name:it.path.split('/').pop()}); }
          return files;
        });
  }
  function handleFileInput(e){
    var f=(e.target&&e.target.files&&e.target.files[0])?e.target.files[0]:null; if(!f) return;
    var r=new FileReader();
    r.onload=()=>{ loadCSVText(String(r.result), f.name.replace(/\.[^.]+$/,'')); };
    r.onerror=()=>{ alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); };
    r.readAsText(f);
  }
  // ------ UI handlers ------
  function addHandlers(){
    let file=$('#file'); if(file) file.addEventListener('change',handleFileInput);
    let reu=$('#reupload'); if(reu) reu.addEventListener('change',handleFileInput);
    let up=$('#uploader');
    if(up){
      ['dragenter','dragover'].forEach(ev=>up.addEventListener(ev,e=>{
        e.preventDefault(); e.stopPropagation(); up.classList.add('drag');
      }));
      ['dragleave','drop'].forEach(ev=>up.addEventListener(ev,e=>{
        e.preventDefault(); e.stopPropagation(); up.classList.remove('drag');
      }));
      up.addEventListener('drop',e=>{
        var f=(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0])?e.dataTransfer.files[0]:null;
        if(f) handleFileInput({target:{files:[f]}});
      });
    }
    $('#templateBtn')?.addEventListener('click',()=>{
      let csv='question,answer\n"–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?","–ü–∞—Ä–∏–∂"\n"2+2?","4"\n"–ì–ª–∞–≤–Ω—ã–π —Ü–≤–µ—Ç –Ω–µ–±–∞ –¥–Ω—ë–º","–°–∏–Ω–∏–π"\n';
      let blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob),a=document.createElement('a');
      a.href=url; a.download='flashcards_template.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    });
    $('#demoBtn')?.addEventListener('click',()=>{
      let demo='question,answer\n"HTTP —Å—Ç–∞—Ç—É—Å 200","OK ‚Äî —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å"\n"Git –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è","git clone <url>"\n"–ö–æ–ª–æ–Ω–∫–∞ A –≤ CSV","–í–æ–ø—Ä–æ—Å"\n"–ö–æ–ª–æ–Ω–∫–∞ B –≤ CSV","–û—Ç–≤–µ—Ç"\n';
      loadCSVText(demo,'–î–µ–º–æ');
    });
    $('#loadUrlBtn')?.addEventListener('click',()=>{
      let inp=$('#urlInput'),url=(inp&&inp.value)?inp.value.trim():'';
      if(!url) return alert('–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ CSV');
      loadFromURL(url)['catch'](e=>alert(e.message||e));
    });
    $('#loadPickedBtn')?.addEventListener('click',()=>{
      var pick=$('#csvPicker');
      if(!pick||!pick.value) return;
      var owner=pick.getAttribute('data-owner'),repo=pick.getAttribute('data-repo'),branch=pick.getAttribute('data-branch')||'main';
      var url=rawURL(owner,repo,branch,pick.value);
      loadFromURL(url)['catch'](e=>alert(e.message||e));
    });
    // –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    window.addEventListener('keydown',function(e){
      var tag=(document.activeElement&&document.activeElement.tagName)||'';
      if(['INPUT','TEXTAREA','SELECT'].includes(tag)) return;
      let f=(id)=>{let el=$(id);if(!el)return; el.classList.add('active');setTimeout(()=>el.classList.remove('active'),180);}
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); $('#revealBtn').click(); f("#revealBtn"); }
      else if(e.key==='ArrowRight'){ $('#nextBtn').click(); f("#nextBtn"); }
      else if(e.key==='ArrowLeft'){ $('#prevBtn').click(); f("#prevBtn"); }
      else if((e.key||'').toLowerCase()==='s'){ $('#shuffleBtn').click(); f("#shuffleBtn"); }
      else if((e.key||'').toLowerCase()==='k'){ $('#markOkBtn').click(); f("#markOkBtn"); }
      else if((e.key||'').toLowerCase()==='j'){ $('#markBadBtn').click(); f("#markBadBtn"); }
    });
    $('#card')?.addEventListener('click',()=>{ shown=!shown; updateUI(); persist(); });
    $('#prevBtn')?.addEventListener('click',()=>{ if(deck.length){ idx=(idx-1+deck.length)%deck.length; shown=false; updateUI(); persist(); } });
    $('#nextBtn')?.addEventListener('click',()=>{ if(deck.length){ idx=(idx+1)%deck.length; shown=false; updateUI(); persist(); } });
    $('#revealBtn')?.addEventListener('click',()=>{ shown=!shown; updateUI(); persist(); });
    $('#shuffleBtn')?.addEventListener('click',()=>{ if(deck.length){ deck=deck.slice(); for(let i=deck.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];} idx=0; shown=false; updateUI(); persist(); } });
    $('#resetBtn')?.addEventListener('click',()=>{ for(let i=0;i<deck.length;i++){ deck[i].ok=false; deck[i].bad=false } idx=0; shown=false; updateUI(); persist(); });
    $('#markOkBtn')?.addEventListener('click',()=>{ if(deck.length){ deck[idx].ok=true; deck[idx].bad=false; idx=Math.min(idx+1,deck.length-1); shown=false; updateUI(); persist(); } });
    $('#markBadBtn')?.addEventListener('click',()=>{ if(deck.length){ deck[idx].bad=true; deck[idx].ok=false; idx=Math.min(idx+1,deck.length-1); shown=false; updateUI(); persist(); } });
    $('#exportBtn')?.addEventListener('click',()=>{
      let out=deck.map((x,i)=>({i,q:x.q,a:x.a,ok:x.ok,bad:x.bad}));
      let blob=new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
      let url=URL.createObjectURL(blob),a=document.createElement('a'); a.href=url; a.download="deck-progress.json";
      a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    });
    $('#clearBtn')?.addEventListener('click',()=>{
      if(confirm("–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")){ localStorage.removeItem('csv-flashcards-v6'); location.reload(); }
    });
  }
  function populatePicker(){
    var pick=$('#csvPicker'), btn=$('#loadPickedBtn');
    if(!pick) return;
    var p=getParams(), owner=p.owner||defaults().owner, repo=p.repo||defaults().repo, branch=p.branch||defaults().branch;
    listCsvViaTrees(owner,repo,branch).then(list=>{
      if(!list.length){ pick.innerHTML='<option>CSV –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>'; if(btn) btn.disabled = true; return;}
      list.sort((a,b)=>a.path.localeCompare(b.path));
      let html=''; for(let i=0;i<list.length;i++){ html+=`<option value="${list[i].path}">${list[i].path}</option>`; }
      pick.innerHTML=html; pick.setAttribute('data-owner',owner); pick.setAttribute('data-repo',repo); pick.setAttribute('data-branch',branch); btn.disabled=false;
      // –∞–≤—Ç–æ‚Äë–ø–æ–¥–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–≥–æ CSV
      let first=list[0]; let url=rawURL(owner,repo,branch,first.path); return loadFromURL(url);
    })['catch'](e=>{ pick.innerHTML='<option>–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞ CSV: '+(e.message||e)+'</option>'; if(btn) btn.disabled=true; });
  }
  function bootstrap(){
    addHandlers();
    if(restore()) return;
    var p=getParams();
    if(p.csv){ loadFromURL(p.csv)['catch'](()=>populatePicker()); return;}
    populatePicker();
  }
  // init
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',bootstrap); } else { bootstrap(); }
  </script>
</body>
</html>
