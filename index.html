<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV Flashcards (albinyok-flashcards)</title>
  <meta name="description" content="–ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ CSV ‚Äî —Ç—Ä—ë—Ö—ä—è–∑—ã—á–Ω–æ–µ, –º–æ–±–∏–ª—å–Ω–æ–µ –∏ –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è." />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --bg:#f4f6fb; --bg-alt:#e6e9f2; --card:#fff; --text:#16204b; --muted:#6c7892; --accent:#865dff; --accent-2:#3fbaff; --ok:#13b77f; --bad:#f44c5c; --shadow:0 6px 24px rgba(40,40,60,0.10);}
    @media (prefers-color-scheme: dark){
      :root{ --bg:#121623; --bg-alt:#181f32; --card:#1c2234; --text:#f4f6fa; --muted:#a7acc6; --shadow:0 6px 24px rgba(0,0,0,0.32);}
    }
    html, body {height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,Arial;
      background: var(--bg);
      color: var(--text);
      line-height:1.45;
      min-height:100vh;
    }
    .container{
      max-width:680px;
      margin:0 auto;
      background: var(--card);
      border-radius:30px;
      box-shadow: var(--shadow);
      padding:32px 22px 42px;
      margin-top:32px;
    }
    header{
      display:flex;align-items:center;gap:12px;margin-bottom:22px;
      flex-wrap:wrap;
    }
    .logo{width:44px;height:44px;border-radius:13px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow);display:grid;place-items:center;color:white;font-weight:800;font-size:21px;}
    h1{font-size:27px;margin:0;}
    .sub{color:var(--muted);font-size:15px;}
    .sub a{color:var(--accent);}
    .lang-select{
      margin-left:auto;position:relative;}
    .lang-flags{border:1.5px solid #ececec;border-radius:11px;background:var(--bg-alt);padding:5px 11px;font-size:15px;appearance:none;}
    .uploader{margin:16px 0 10px;padding:15px 10px 15px 18px;border:2px dashed #ccc;border-radius:18px;background:var(--bg-alt);}
    .uploader.drag{border-color:var(--accent);}
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:12px;}
    .btn{appearance:none;border:none;background:var(--accent);color:#fff;border-radius:12px;padding:10px 15px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:filter .16s;}
    .btn.secondary{background:var(--accent-2);}
    .btn.ghost{background:transparent;color:var(--accent);border:1.5px solid var(--accent);}
    .btn:active,.btn.active{filter:brightness(0.83);}
    input[type=file]{display:none;}
    label.file{display:inline-flex;gap:9px;align-items:center;background:var(--card);border:1.2px solid #eee;padding:11px 14px;margin-right:2px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);}
    .urlbox{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
    .urlbox input[type=url]{flex:1;min-width:150px;border-radius:12px;border:1.5px solid #e4e5ef;padding:8px 11px;background:var(--card);}
    .picker{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
    select{border-radius:12px;border:1.5px solid #e4e5ef;padding:9px 10px;background:var(--card);}
    .gh-bar{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin:10px 0;}
    .gh-bar input{border-radius:8px;border:1.2px solid #e4e5ef;padding:7px 8px;width:90px;}
    .workspace{display:none;margin-top:24px;}
    .chip{background:var(--card);border:1px solid #eee;padding:6px 10px 5px;border-radius:999px;box-shadow:var(--shadow);font-size:13px}
    .progress{margin-top:6px;height:8px;background:#e2e3ed;border-radius:999px;overflow:hidden;}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;}
    .card{position:relative;background:var(--card);border-radius:26px;box-shadow:var(--shadow);padding:20px 10px 24px;display:flex;flex-direction:column;align-items:stretch;justify-content:center;text-align:center;}
    .q{font-size:clamp(18px,2.4vw,21px);font-weight:700;margin-bottom:22px;}
    .a{font-size:clamp(16px,2vw,19px);color:var(--muted);}
    .controls{display:flex;flex-wrap:wrap;gap:9px;align-items:center;justify-content:center;margin-top:14px;}
    .ctrl{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1.5px solid #eaeaf0;background:var(--card);cursor:pointer;box-shadow:var(--shadow);font-weight:700;transition:filter .15s;}
    .ctrl.ok{color:var(--ok);}
    .ctrl.bad{color:var(--bad);}
    .ctrl.active{filter:brightness(0.66);}
    .topbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .tiny{font-size:12px;color:var(--muted);}
    .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#e6e9f2;padding:2px 6px;border-radius:6px;}
    .hidden{display:none !important;}
    .error{padding:12px 14px;border-radius:12px;background:rgba(255,0,0,.09);border:1px solid #e49c9c;margin-top:10px;color:#b11212;}
    .exportbar{display:flex;gap:10px;margin-top:18px;justify-content:center;flex-wrap:wrap;}
    @media (max-width:600px){
      .container{padding:11px 2vw 20px;margin:8px;}
      .card{padding:10px 1.3vw 13px;}
      header h1{font-size:19px;}
      .row,.controls,.exportbar{flex-direction:column;gap:7px;}
      .uploader{padding:7px 2vw 11px;}
      .exportbar{align-items:stretch;}
    }
    @media (max-width:400px){
      .card{font-size:16px;}
      header{gap:5px;}
      .sub{font-size:12px;}
      .btn,.ctrl,label.file{font-size:13px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Q‚ÜîA</div>
      <div>
        <h1 id="siteTitle">CSV Flashcards</h1>
        <div class="sub" id="siteSub"></div>
      </div>
      <div class="lang-select">
        <select id="langSelect" class="lang-flags" aria-label="Language">
          <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="en">üá¨üáß English</option>
          <option value="fr">üá´üá∑ Fran√ßais</option>
        </select>
      </div>
    </header>
    <section class="uploader" id="uploader" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞ CSV">
      <h2 id="fileOrLink"></h2>
      <div class="row" style="margin-bottom:13px">
        <label for="file" class="file" id="fileLabel"><span id="fileIcon">üìÑ</span>
          <span id="fileBtnTxt"></span>
        </label>
        <input type="file" id="file" accept=".csv,text/csv" />
        <input type="url" id="urlInput" style="width:260px;margin-left:10px;" />
        <button class="btn" id="loadUrlBtn" type="button"></button>
        <select id="csvPicker" style="margin-left:10px;"><option value=""></option></select>
        <button class="btn" id="loadPickedBtn" type="button" disabled></button>
      </div>
      <div class="gh-bar">
        <input id="ghOwner" value="24tiy" maxlength="32" aria-label="GitHub User/Org"/>
        <input id="ghRepo" value="albinyok-flashcards" maxlength="40" aria-label="GitHub Repo"/>
        <input id="ghBranch" value="main" maxlength="24" aria-label="Branch"/>
        <button class="btn ghost" id="changeGHBtn" type="button"></button>
      </div>
      <div id="error" class="error hidden" role="alert"></div>
    </section>

    <section class="workspace" id="workspace" aria-live="polite">
      <div class="topbar">
        <div>
          <span class="chip" id="deckName"></span>
          <span class="chip" id="counter">0 / 0</span>
          <span class="chip" id="score">‚úì 0 ‚Ä¢ ‚úó 0</span>
        </div>
        <div>
          <button class="btn ghost" id="shuffleBtn" title="S"></button>
          <button class="btn ghost" id="resetBtn" title="R"></button>
          <label class="file" for="reupload">‚Üª CSV</label>
          <input type="file" id="reupload" accept=".csv,text/csv" />
        </div>
      </div>
      <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
      <div class="card" id="card">
        <div class="q" id="q"></div>
        <div class="a" id="a"></div>
      </div>
      <div class="controls" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
        <button class="ctrl" id="prevBtn" title="‚Üê"></button>
        <button class="ctrl" id="revealBtn" title=" "></button>
        <button class="ctrl" id="nextBtn" title="‚Üí"></button>
        <button class="ctrl ok" id="markOkBtn" title="K"></button>
        <button class="ctrl bad" id="markBadBtn" title="J"></button>
      </div>
      <div class="tiny" style="text-align:center;margin-top:8px" id="hotkeysTip"></div>
    </section>
    <div class="exportbar">
      <button class="btn" id="exportBtn"></button>
      <button class="btn ghost" id="clearBtn"></button>
      <button class="btn secondary" id="templateBtn" type="button"></button>
      <button class="btn ghost" id="demoBtn" type="button"></button>
      <a id="helpLink" href="README.md" target="_blank" class="btn ghost"></a>
    </div>
  </div>
<script>
// ----------- –ü–µ—Ä–µ–≤–æ–¥—ã ----------
const translations = {
  ru: {
    siteTitle:"CSV Flashcards",
    siteSub:'–§–ª–µ—à‚Äë–∫–∞—Ä—Ç—ã –∏–∑ CSV ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å—Å—ã–ª–∫—É —Å GitHub. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.',
    fileOrLink:"–û—Ç–∫—É–¥–∞ –±–µ—Ä—ë–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é?",
    fileBtn:"–§–∞–π–ª CSV",
    template:"–®–∞–±–ª–æ–Ω CSV",
    demo:"–î–µ–º–æ-–Ω–∞–±–æ—Ä",
    urlBtn:"–ü–æ —Å—Å—ã–ª–∫–µ",
    repoBtn:"–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ GitHub",
    ghBarBtn:"–°–º–µ–Ω–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π",
    owner:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    repo:"–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π",
    branch:"–í–µ—Ç–∫–∞",
    noCSVs:"CSV –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
    ghApiErr:"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GitHub: ",
    selectPlaceholder:"‚Ä¶–∏—â–µ–º CSV –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏‚Ä¶",
    urlPlaceholder:"https://raw.githubusercontent.com/24tiy/albinyok-flashcards/main/Questions_et_r_ponses.csv",
    reveal:"–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç",
    hide:"–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç",
    prev:"‚Üê –ù–∞–∑–∞–¥",
    next:"–í–ø–µ—Ä—ë–¥ ‚Üí",
    know:"‚úì –ó–Ω–∞—é",
    dont:"‚úó –ù–µ –∑–Ω–∞—é",
    shuffle:"–ü–µ—Ä–µ–º–µ—à–∞—Ç—å",
    reset:"–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å",
    deck:"–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤",
    empty:"–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è",
    progress:"–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞",
    clear:"–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë",
    hotkeys:"Space/Enter ‚Äî –æ—Ç–≤–µ—Ç ¬∑ ‚Üê/‚Üí ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è ¬∑ J/K ‚Äî –Ω–µ –∑–Ω–∞—é/–∑–Ω–∞—é ¬∑ S ‚Äî –ø–µ—Ä–µ–º–µ—à–∞—Ç—å",
    errorPref:"–û—à–∏–±–∫–∞: ",
    ghInvalid:"–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ .csv –∏–ª–∏ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GitHub.",
    ghChanged:"–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –æ–±–Ω–æ–≤–ª—ë–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å–Ω–æ–≤–∞.",
    fetchFail:"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏",
    fileTooBig:"–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!",
    csvNotPairs:"–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–∞—Ä '–≤–æ–ø—Ä–æ—Å/–æ—Ç–≤–µ—Ç'",
    help: "–ü–æ–º–æ—â—å"
  },
  en: {
    siteTitle:"CSV Flashcards",
    siteSub:'Flashcards from CSV ‚Äî upload a file or paste a GitHub link. Your progress is saved locally.',
    fileOrLink:"Source of Questions?",
    fileBtn:"CSV File",
    template:"Template CSV",
    demo:"Demo Set",
    urlBtn:"Load Link",
    repoBtn:"Load from GitHub",
    ghBarBtn:"Change Repo",
    owner:"User",
    repo:"Repo",
    branch:"Branch",
    noCSVs:"No CSV files found in repo",
    ghApiErr:"GitHub API failure: ",
    selectPlaceholder:"‚Ä¶searching CSVs in repo‚Ä¶",
    urlPlaceholder:"https://raw.githubusercontent.com/24tiy/albinyok-flashcards/main/Questions_et_r_ponses.csv",
    reveal:"Show answer",
    hide:"Hide answer",
    prev:"‚Üê Back",
    next:"Next ‚Üí",
    know:"‚úì I know",
    dont:"‚úó Don't know",
    shuffle:"Shuffle",
    reset:"Reset progress",
    deck:"Source",
    empty:"Upload a CSV or select from repo",
    progress:"Export progress",
    clear:"Clear all",
    hotkeys:"Space/Enter ‚Äî answer ¬∑ ‚Üê/‚Üí ‚Äî navigation ¬∑ J/K ‚Äî don't/know ¬∑ S ‚Äî shuffle",
    errorPref:"Error: ",
    ghInvalid:"No CSV files present or GitHub access error.",
    ghChanged:"Repo settings updated. Try loading a file again.",
    fetchFail:"Download error",
    fileTooBig:"File too large!",
    csvNotPairs:"No question/answer pairs found",
    help:"Help"
  },
  fr: {
    siteTitle:"CSV Flashcards",
    siteSub:'Cartes m√©moire √† partir de CSV¬†: chargez un fichier ou un lien GitHub. Vos progr√®s sont sauvegard√©s localement.',
    fileOrLink:"Source de questions¬†?",
    fileBtn:"Fichier CSV",
    template:"Mod√®le CSV",
    demo:"Jeu d√©mo",
    urlBtn:"Depuis le lien",
    repoBtn:"Charger depuis GitHub",
    ghBarBtn:"Changer de d√©p√¥t",
    owner:"Utilisateur",
    repo:"D√©p√¥t",
    branch:"Branche",
    noCSVs:"Aucun CSV trouv√© dans le d√©p√¥t",
    ghApiErr:"Erreur GitHub API¬†: ",
    selectPlaceholder:"‚Ä¶recherche des CSV dans le d√©p√¥t‚Ä¶",
    urlPlaceholder:"https://raw.githubusercontent.com/24tiy/albinyok-flashcards/main/Questions_et_r_ponses.csv",
    reveal:"Afficher r√©ponse",
    hide:"Cacher la r√©ponse",
    prev:"‚Üê Pr√©c√©dent",
    next:"Suivant ‚Üí",
    know:"‚úì Je sais",
    dont:"‚úó Je ne sais pas",
    shuffle:"M√©langer",
    reset:"R√©initialiser",
    deck:"Source",
    empty:"Chargez un CSV ou choisissez un fichier de d√©p√¥t",
    progress:"Exporter progr√®s",
    clear:"Tout nettoyer",
    hotkeys:"Space/Enter ‚Äî r√©ponse ¬∑ ‚Üê/‚Üí ‚Äî navigation ¬∑ J/K ‚Äî je ne sais/sais pas ¬∑ S ‚Äî m√©langer",
    errorPref:"Erreur¬†: ",
    ghInvalid:"Pas de CSV dans le d√©p√¥t ou erreur d‚Äôacc√®s GitHub.",
    ghChanged:"D√©p√¥t mis √† jour. Essayez de charger √† nouveau.",
    fetchFail:"Erreur de t√©l√©chargement",
    fileTooBig:"Fichier trop volumineux¬†!",
    csvNotPairs:"Aucune paire question/r√©ponse trouv√©e",
    help:"Aide"
  }
};
let curLang = "ru";
function t(k){return translations[curLang][k]||k;}
document.getElementById("langSelect").addEventListener("change",function(e){
  curLang = this.value; updateLang();
});
function updateLang(){
  document.documentElement.lang=curLang;
  $("#siteTitle").textContent = t("siteTitle");
  $("#siteSub").textContent = t("siteSub");
  $("#fileOrLink").textContent = t("fileOrLink");
  $("#fileBtnTxt").textContent = t("fileBtn");
  $("#templateBtn").textContent = t("template");
  $("#demoBtn").textContent = t("demo");
  $("#loadUrlBtn").textContent = t("urlBtn");
  $("#loadPickedBtn").textContent = t("repoBtn");
  $("#changeGHBtn").textContent = t("ghBarBtn");
  $("#ghOwner").setAttribute("aria-label", t("owner"));
  $("#ghRepo").setAttribute("aria-label", t("repo"));
  $("#ghBranch").setAttribute("aria-label", t("branch"));
  $("#urlInput").placeholder = t("urlPlaceholder");
  // select-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
  let pick=$("#csvPicker");
  if(pick && pick.options.length && pick.options[0].value===""){
    pick.options[0].textContent = t("selectPlaceholder");
  }
  $("#prevBtn").textContent = t("prev");
  $("#revealBtn").textContent = t("reveal");
  $("#nextBtn").textContent = t("next");
  $("#markOkBtn").textContent = t("know");
  $("#markBadBtn").textContent = t("dont");
  $("#shuffleBtn").textContent = t("shuffle");
  $("#resetBtn").textContent = t("reset");
  $("#exportBtn").textContent = t("progress");
  $("#clearBtn").textContent = t("clear");
  $("#deckName").textContent = `${t('deck')}: ‚Äî`;
  $("#hotkeysTip").textContent = t("hotkeys");
  $("#helpLink").textContent = t("help");
}
function $(s){return document.querySelector(s);}
function sniffHeader(a){
  if(!a || a.length<2) return false;
  let ha=(a[0]||'').toLowerCase(), hb=(a[1]||'').toLowerCase();
  return ['q','question','–≤–æ–ø—Ä–æ—Å','question'].includes(ha) && ['a','answer','–æ—Ç–≤–µ—Ç','r√©ponse'].includes(hb);
}
function toDeck(rows){
  if(!rows||!rows.length) return [];
  let filtered=[];
  for(let r of rows){
    let q=(r[0]||'').trim(), a=(r[1]||'').trim();
    if(q+a==='') continue;
    filtered.push([q,a]);
  }
  if(!filtered.length) return [];
  let skip=sniffHeader(filtered[0]) ? 1:0, out=[];
  for(let i=skip;i<filtered.length;i++)
    out.push({q:filtered[i][0], a:filtered[i][1], ok:false, bad:false});
  return out;
}
let deck=[], idx=0, shown=false, deckName='‚Äî';
function updateUI(){
  let q=$("#q"), a=$("#a"), c=$("#counter"), s=$("#score"), n=$("#deckName"), bar=$("#progressBar");
  if(!deck.length){
    q.textContent = t("empty"); a.textContent = ""; a.style.display = "none";
    if (c) c.textContent = "0 / 0";
    if (s) s.textContent = "‚úì 0 ‚Ä¢ ‚úó 0";
    if (n) n.textContent = `${t('deck')}: ‚Äî`;
    if (bar) bar.style.width = "0%";
    return;
  }
  let card=deck[idx];
  q.textContent = card.q || `(${t('deck')})`;
  a.textContent = card.a || `(‚Äî)`;
  a.style.display = "block";
  if (!shown) a.style.visibility = "hidden"; else a.style.visibility = "visible";
  if (c) c.textContent = `${idx+1} / ${deck.length}`;
  let ok=deck.filter(x=>x.ok).length, bad=deck.filter(x=>x.bad).length;
  if (s) s.textContent = `‚úì ${ok} ‚Ä¢ ‚úó ${bad}`;
  if (n) n.textContent = `${t('deck')}: ${deckName}`;
  let rb=$("#revealBtn"); if(rb) rb.textContent = shown?t("hide"):t("reveal");
}
function showWorkspace(){ $("#uploader").classList.add("hidden"); $("#workspace").style.display="block"; }
function showUploader(){ $("#uploader").classList.remove("hidden"); $("#workspace").style.display="none"; }
function persist(){
  localStorage.setItem('csv-flashcards-v8',JSON.stringify({deck,idx,shown,deckName,lang:curLang}));
}
function restore(){
  try{
    let raw=localStorage.getItem('csv-flashcards-v8');
    if(!raw) return false;
    let p=JSON.parse(raw);
    if(p && p.deck && p.deck.length){
      deck=p.deck; idx=Math.min(Math.max(0,p.idx|0),deck.length-1); shown=!!p.shown; deckName=p.deckName||'‚Äî';
      if(p.lang) { curLang=p.lang; $("#langSelect").value=curLang; }
      updateLang(); showWorkspace(); updateUI(); return true;
    }
  }catch(e){}
  return false;
}
function loadCSVText(text,name){
  try{
    let parsed = Papa.parse(text.trim(), {skipEmptyLines:true});
    if(parsed.errors && parsed.errors.length) throw new Error(parsed.errors[0].message);
    let d=toDeck(parsed.data);
    if(!d.length) throw new Error(t("csvNotPairs"));
    deck = d; idx=0; shown=false; deckName=name||'';
    persist(); showWorkspace(); updateUI();
  }catch(e){
    let err=$("#error");
    if(err){ err.textContent=t("errorPref") + (e.message||e); err.classList.remove("hidden"); }
    showUploader();
  }
}
function loadFromURL(url){
  return fetch(url,{cache:"no-store"}).then(res=>{
    if(!res.ok) throw new Error(`${t("fetchFail")} (${res.status})`);
    if(+res.headers.get("content-length")>500000) throw new Error(t("fileTooBig"));
    return res.text();
  }).then(txt=>{
    let name=decodeURIComponent(url.split("/").pop()||"Remote CSV");
    loadCSVText(txt,name);
  });
}
function rawURL(owner,repo,branch,path){
  return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
}
function listCsvViaTrees(owner,repo,branch){
  let url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
  return fetch(url,{headers:{"Accept":"application/vnd.github+json"}})
    .then(res=>{
      if(!res.ok) throw new Error(`${t("ghApiErr")}${res.status}`);
      return res.json();
    })
    .then(data=>{
      let tree=(data&&data.tree)?data.tree:[], files=[];
      for(let it of tree){ if(it.type==="blob" && /\.csv$/i.test(it.path)) files.push({path:it.path, name:it.path.split("/").pop()}); }
      return files;
    });
}
function handleFileInput(e){
  let f=(e.target&&e.target.files&&e.target.files[0])?e.target.files[0]:null; if(!f) return;
  let r=new FileReader();
  r.onload=()=>{ loadCSVText(String(r.result), f.name.replace(/\.[^.]+$/,"")); };
  r.onerror=()=>{ alert(t("errorPref")+" Read file error"); };
  r.readAsText(f);
}
function addHandlers(){
  ["file","reupload"].forEach(id=>{
    let el=$("#"+id); if(el) el.addEventListener("change",handleFileInput);
  });
  let up=$("#uploader");
  if(up){
    ["dragenter","dragover"].forEach(ev=>up.addEventListener(ev,e=>{
      e.preventDefault(); e.stopPropagation(); up.classList.add("drag");
    }));
    ["dragleave","drop"].forEach(ev=>up.addEventListener(ev,e=>{
      e.preventDefault(); e.stopPropagation(); up.classList.remove("drag");
    }));
    up.addEventListener("drop",e=>{
      let f=(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0])?e.dataTransfer.files[0]:null;
      if(f) handleFileInput({target:{files:[f]}});
    });
  }
  $("#templateBtn")?.addEventListener("click",()=>{
    let csv='question,answer\n"–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?","–ü–∞—Ä–∏–∂"\n"2+2?","4"\n"–ì–ª–∞–≤–Ω—ã–π —Ü–≤–µ—Ç –Ω–µ–±–∞ –¥–Ω—ë–º","–°–∏–Ω–∏–π"\n';
    let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}),url=URL.createObjectURL(blob),a=document.createElement("a");
    a.href=url; a.download="flashcards_template.csv"; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
  });
  $("#demoBtn")?.addEventListener("click",()=>{
    let demo='question,answer\n"–°—Ç–æ–ª–∏—Ü–∞ –§—Ä–∞–Ω—Ü–∏–∏?","–ü–∞—Ä–∏–∂"\n"What is the capital of France?","Paris"\n"Quelle est la capitale de la France?","Paris"\n"2+2?","4"\n"–Ø–∑—ã–∫ Python ‚Äî —ç—Ç–æ...","–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è"\n"Python is a...","Programming language"\n"Python est un...","Langage de programmation"\n';
    loadCSVText(demo,"Demo");
  });
  $("#loadUrlBtn")?.addEventListener("click",()=>{
    let inp=$("#urlInput"),url=(inp&&inp.value)?inp.value.trim():"";
    if(!url) return alert("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ CSV");
    loadFromURL(url)["catch"](e=>alert(e.message||e));
  });
  $("#loadPickedBtn")?.addEventListener("click",()=>{
    let pick=$("#csvPicker");
    if(!pick||!pick.value) return;
    let owner=pick.getAttribute("data-owner"),repo=pick.getAttribute("data-repo"),branch=pick.getAttribute("data-branch")||"main";
    let url=rawURL(owner,repo,branch,pick.value);
    loadFromURL(url)["catch"](e=>alert(e.message||e));
  });
  window.addEventListener("keydown",function(e){
    let tag=(document.activeElement&&document.activeElement.tagName)||"";
    if(["INPUT","TEXTAREA","SELECT"].includes(tag)) return;
    let f=(id)=>{let el=$(id);if(!el)return; el.classList.add("active");setTimeout(()=>el.classList.remove("active"),180);}
    if(e.key===" "||e.key==="Enter"){ e.preventDefault(); $("#revealBtn").click(); f("#revealBtn"); }
    else if(e.key==="ArrowRight"){ $("#nextBtn").click(); f("#nextBtn"); }
    else if(e.key==="ArrowLeft"){ $("#prevBtn").click(); f("#prevBtn"); }
    else if((e.key||"").toLowerCase()==="s"){ $("#shuffleBtn").click(); f("#shuffleBtn"); }
    else if((e.key||"").toLowerCase()==="k"){ $("#markOkBtn").click(); f("#markOkBtn"); }
    else if((e.key||"").toLowerCase()==="j"){ $("#markBadBtn").click(); f("#markBadBtn"); }
  });
  $("#card")?.addEventListener("click",()=>{shown=!shown; updateUI(); persist();});
  $("#prevBtn")?.addEventListener("click",()=>{ if(deck.length){ idx=(idx-1+deck.length)%deck.length; shown=false; updateUI(); persist();}});
  $("#nextBtn")?.addEventListener("click",()=>{ if(deck.length){ idx=(idx+1)%deck.length; shown=false; updateUI(); persist();}});
  $("#revealBtn")?.addEventListener("click",()=>{ shown=!shown; updateUI(); persist();});
  $("#shuffleBtn")?.addEventListener("click",()=>{
    if(deck.length){
      deck=deck.slice(); for(let i=deck.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}
      idx=0; shown=false; updateUI(); persist();
    }
  });
  $("#resetBtn")?.addEventListener("click",()=>{ for(let i=0;i<deck.length;i++){deck[i].ok=false;deck[i].bad=false;} idx=0; shown=false; updateUI();persist();});
  $("#markOkBtn")?.addEventListener("click",()=>{if(deck.length){deck[idx].ok=true;deck[idx].bad=false;idx=Math.min(idx+1,deck.length-1);shown=false;updateUI();persist();}});
  $("#markBadBtn")?.addEventListener("click",()=>{if(deck.length){deck[idx].bad=true;deck[idx].ok=false;idx=Math.min(idx+1,deck.length-1);shown=false;updateUI();persist();}});
  $("#exportBtn")?.addEventListener("click",()=>{
    let out=deck.map((x,i)=>({i,q:x.q,a:x.a,ok:x.ok,bad:x.bad}));
    let blob=new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
    let url=URL.createObjectURL(blob),a=document.createElement("a");
    a.href=url; a.download="deck-progress.json";
    a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
  });
  $("#clearBtn")?.addEventListener("click",()=>{
    if(confirm("–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")){ localStorage.removeItem("csv-flashcards-v8"); location.reload(); }
  });
  $("#changeGHBtn")?.addEventListener("click",()=>{
    let owner=$("#ghOwner").value.trim(), repo=$("#ghRepo").value.trim(), branch=$("#ghBranch").value.trim();
    populatePicker(owner,repo,branch);
    let pick=$("#csvPicker"); if(pick){pick.innerHTML = `<option>${t("selectPlaceholder")}</option>`;}
    $("#error").classList.add("hidden");
    setTimeout(()=>alert(t("ghChanged")),200);
  });
}
function populatePicker(owner,repo,branch){
  owner=owner||$("#ghOwner").value.trim(); repo=repo||$("#ghRepo").value.trim();branch=branch||$("#ghBranch").value.trim();
  let pick=$("#csvPicker"), btn=$("#loadPickedBtn");
  if(!pick) return;
  pick.innerHTML = `<option>${t("selectPlaceholder")}</option>`; btn.disabled = true;
  listCsvViaTrees(owner,repo,branch)
    .then(list=>{
      if(!list.length){pick.innerHTML = `<option>${t("noCSVs")}</option>`; btn.disabled = true;return;}
      list.sort((a,b)=>a.path.localeCompare(b.path));
      let html=""; for(let item of list){ html+=`<option value="${item.path}">${item.path}</option>`;}
      pick.innerHTML=html;
      pick.setAttribute("data-owner",owner);
      pick.setAttribute("data-repo",repo);
      pick.setAttribute("data-branch",branch);
      btn.disabled=false;
    })["catch"](e=>{
      pick.innerHTML = `<option>${t("ghInvalid")} (${e.message||e})</option>`;
      btn.disabled=true;
    });
}
function bootstrap(){
  addHandlers();
  updateLang();
  if(restore()) return;
  var params=new URLSearchParams(window.location.search);
  let owner=params.get("owner")||$("#ghOwner").value,repo=params.get("repo")||$("#ghRepo").value,branch=params.get("branch")||$("#ghBranch").value;
  if(params.get("csv")){
    let url=rawURL(owner,repo,branch,params.get("csv"));
    loadFromURL(url)["catch"](()=>populatePicker(owner,repo,branch));
    return;
  }
  populatePicker(owner,repo,branch);
}
// Init –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",bootstrap);}else{bootstrap();}
</script>
</body>
</html>
